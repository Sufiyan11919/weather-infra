name: Promote GA via ECR
on:
  push:
    # only tags without "-rc"
    tags:
      - 'v*.*.*'

env:
  AWS_REGION: us-east-2
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  SERVICES: weather-api weather-frontend favourite-api
  GA_TAG: ${{ github.ref_name }}       # e.g. "v1.4.0"

jobs:
  retag-and-bump:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS creds
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: Retag RC images to GA
        run: |
          for svc in $SERVICES; do
            echo "â³ Finding latest RC for $svc..."
            # List all image tags, filter rcâ€™s, sort by pushed date, take the latest
            LATEST_RC=$(aws ecr describe-images \
              --repository-name $svc \
              --query 'reverse(sort_by(imageDetails,&imagePushedAt))[?starts_with(imageTags[0],`'${GA_TAG}'-rc.`)].imageTags[0]' \
              --output text | head -1)

            echo "ðŸ”– Retagging $svc:$LATEST_RC â†’ $svc:$GA_TAG"
            # pull the manifest
            aws ecr batch-get-image \
              --repository-name $svc \
              --image-ids imageTag=$LATEST_RC \
              --query 'images[0].imageManifest' --output text \
              > manifest.json

            # push under GA tag
            aws ecr put-image \
              --repository-name $svc \
              --image-tag $GA_TAG \
              --image-manifest file://manifest.json
          done

      - name: Bump prod values and open PR
        run: |
          git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/Sufiyan11919/weather-infra.git
          cd weather-infra
          git checkout -b bump-prod-$GA_TAG

          for svc in $SERVICES; do
            FILE=environments/prod/$svc/values.yaml
            # update the image tag
            sed -i "s|tag:.*|tag: \"$GA_TAG\"|" $FILE
          done

          git commit -am "chore: promote services to $GA_TAG"
          git push -u origin HEAD

          gh pr create \
            --title  "Promote all services â†’ $GA_TAG" \
            --body   "Automated GA promotion" \
            --base   main \
            --head   bump-prod-$GA_TAG
