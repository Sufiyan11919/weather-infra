name: Promote GA via ECR

on:
  push:
    # runs only for GA tags such as v2.0.0 (âš ï¸ no â€œ-rcâ€)
    tags:
      - 'v*.*.*'

env:
  AWS_REGION: us-east-2
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  SERVICES: favourite-api weather-api weather-frontend
  GA_TAG: ${{ github.ref_name }}            # e.g. "v2.0.0"

jobs:
  retag-and-bump:
    runs-on: ubuntu-latest

    steps:
    #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. checkout infra repo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. AWS creds for ECR access â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region:            ${{ env.AWS_REGION }}

    #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. Re-tag RC â†’ GA in ECR (skip if GA exists) â”€â”€â”€â”€
    - name: Retag RC images to GA (skip existing)
      run: |
        set -euo pipefail

        for svc in $SERVICES; do
          echo "ğŸ” Checking if $svc already has GA tag ${GA_TAG}..."
          GA_EXISTS=$(aws ecr list-images \
            --repository-name "$svc" \
            --filter tagStatus=TAGGED \
            --query "contains(imageIds[].imageTag, '${GA_TAG}')" \
            --output text)

          if [ "$GA_EXISTS" = "True" ] || [ "$GA_EXISTS" = "true" ]; then
            echo "âœ… $svc:$GA_TAG already existsâ€”skipping retag."
            continue
          fi

          echo "â³ Extracting RC tag from UAT overlay for $svc..."
          RC_TAG=$(grep '^  tag:' uat/environments/$svc/values.yaml \
                   | awk -F'"' '{print $2}')

          if [[ ! "$RC_TAG" =~ ^${GA_TAG}-rc\.[0-9]+$ ]]; then
            echo "âŒ Unexpected RC tag '$RC_TAG' for $svcâ€”aborting."
            exit 1
          fi

          echo "ğŸ”– Retagging $svc:$RC_TAG â†’ $svc:$GA_TAG"
          aws ecr batch-get-image \
            --repository-name "$svc" \
            --image-ids imageTag="$RC_TAG" \
            --query 'images[0].imageManifest' --output text \
            > manifest.json

          aws ecr put-image \
            --repository-name "$svc" \
            --image-tag "$GA_TAG" \
            --image-manifest file://manifest.json
        done

    #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. Bump prod overlays to GA tag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Create bump branch & update prod overlays
      run: |
        git checkout -b bump-prod-${GA_TAG}

        for svc in $SERVICES; do
          FILE=prod/environments/$svc/values.yaml
          echo "âœï¸  Updating $FILE â†’ tag: ${GA_TAG}"
          sed -i "s|tag:.*|tag: \"${GA_TAG}\"|" "$FILE"
        done

        git commit -am "chore: promote services â†’ ${GA_TAG}"

    #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5. Open PR with peter-evans/create-pull-request â”€
    - name: Open Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        title: "Promote all services â†’ ${GA_TAG}"
        commit-message: "chore: promote services â†’ ${GA_TAG}"
        body: "Automated GA promotion from infra"
        branch: "bump-prod-${GA_TAG}"
        base: main
