# .github/workflows/promote-ga.yml
name: Promote GA via ECR

on:
  push:
    tags:
      - 'v*.*.*'     # fire on e.g. v1.4.0 (no -rc)

env:
  AWS_REGION: us-east-2
  SERVICES: favourite-api weather-api weather-frontend
  GA_TAG: ${{ github.ref_name }}  # e.g. “v1.4.0”

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout infra repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: Retag UAT RC → GA in ECR (skip if exists)
        run: |
          set -euo pipefail
          for svc in $SERVICES; do
            echo "🔍 $svc: does GA tag $GA_TAG already exist?"
            if aws ecr list-images \
                 --repository-name "$svc" \
                 --filter tagStatus=TAGGED \
                 --query "contains(imageIds[].imageTag, '$GA_TAG')" \
                 --output text | grep -q 'true'; then
              echo "✅ $svc:$GA_TAG exists—skipping"
              continue
            fi

            echo "⏳ $svc: extracting RC from UAT overlay…"
            RC_TAG=$(grep '^  tag:' environments/uat/$svc/values.yaml \
                     | awk -F'"' '{print $2}')

            echo "🔖 $svc: retag $RC_TAG → $GA_TAG"
            aws ecr batch-get-image \
              --repository-name "$svc" \
              --image-ids imageTag="$RC_TAG" \
              --query 'images[0].imageManifest' --output text \
              > manifest.json

            aws ecr put-image \
              --repository-name "$svc" \
              --image-tag "$GA_TAG" \
              --image-manifest file://manifest.json
          done

      - name: Create bump branch & update prod overlays
        run: |
          git checkout -b bump-prod-${GA_TAG}
          for svc in $SERVICES; do
            file=environments/prod/$svc/values.yaml
            sed -i "s|tag:.*|tag: \"${GA_TAG}\"|" "$file"
          done
          git commit -am "chore: promote services → ${GA_TAG}"

      - name: Open Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: Promote all services → ${{ env.GA_TAG }}
          commit-message: chore: promote services → ${{ env.GA_TAG }}
          head: bump-prod-${{ env.GA_TAG }}
          base: main
          body: Automated GA promotion from infra
